<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wartungsprotokoll - Ta-SIEMPlus</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/ta-alpha-brand.css">
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-link" title="Zur√ºck">&#8592;</a>
            <div class="header-inner" style="padding-left: 48px;">
                <img src="assets/ta-alpha-logo.svg" alt="T-Alpha GmbH" class="header-logo">
                <div class="header-text">
                    <h1>Wartungsprotokoll</h1>
                    <p class="subtitle">T-Alpha GmbH &middot; IT Security</p>
                </div>
            </div>
        </header>

        <div class="content">
            <!-- Basic Information -->
            <div class="section">
                <h2>üìù Grundinformationen</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Operator</label>
                        <input type="text" id="operator" placeholder="Max Mustermann">
                    </div>
                    <div class="form-group">
                        <label>Kunde</label>
                        <input type="text" id="customer" placeholder="Beispiel AG">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Infrastruktur</label>
                        <input type="text" id="infrastructure" placeholder="wazuh-prod-01">
                    </div>
                    <div class="form-group">
                        <label>Change Ticket ID</label>
                        <input type="text" id="changeTicket" placeholder="CHG0012345">
                    </div>
                </div>

                <div class="form-group">
                    <label>Wartungstyp</label>
                    <select id="maintenanceType">
                        <option value="upgrade">Upgrade</option>
                        <option value="incident">Incident Response</option>
                        <option value="configuration">Konfigurations√§nderung</option>
                        <option value="troubleshooting">Troubleshooting</option>
                        <option value="backup">Backup/Restore</option>
                        <option value="monitoring">Monitoring-Anpassung</option>
                        <option value="other">Sonstiges</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Wartungsbeschreibung</label>
                    <textarea id="description" rows="3" placeholder="Kurze Beschreibung der durchzuf√ºhrenden Arbeiten..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Geplanter Start</label>
                        <input type="datetime-local" id="plannedStart">
                    </div>
                    <div class="form-group">
                        <label>Geplantes Ende</label>
                        <input type="datetime-local" id="plannedEnd">
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        Status
                        <span class="status-badge status-planned" id="statusBadge">Geplant</span>
                    </label>
                    <select id="status" onchange="updateStatusBadge()">
                        <option value="planned">Geplant</option>
                        <option value="in-progress">In Bearbeitung</option>
                        <option value="completed">Abgeschlossen</option>
                    </select>
                </div>
            </div>

            <!-- Time Tracking -->
            <div class="section">
                <h2>‚è±Ô∏è Zeiterfassung</h2>
                
                <div class="time-tracker">
                    <div class="time-display" id="timeDisplay">00:00:00</div>
                    
                    <div class="timer-controls">
                        <button class="btn-success" id="startBtn" onclick="startTimer()">‚ñ∂Ô∏è Start</button>
                        <button class="btn-warning" id="pauseBtn" onclick="pauseTimer()" disabled>‚è∏Ô∏è Pause</button>
                        <button class="btn-danger" id="stopBtn" onclick="stopTimer()" disabled>‚èπÔ∏è Stop</button>
                        <button class="btn-secondary" onclick="resetTimer()">üîÑ Reset</button>
                    </div>

                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Tats√§chlicher Start</label>
                            <input type="datetime-local" id="actualStart" readonly>
                        </div>
                        <div class="form-group">
                            <label>Tats√§chliches Ende</label>
                            <input type="datetime-local" id="actualEnd" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Gesamtdauer (Minuten)</label>
                        <input type="number" id="totalDuration" readonly>
                    </div>
                </div>
            </div>

            <!-- Pre-Maintenance -->
            <div class="section">
                <h2>üîç Vor der Wartung</h2>
                
                <div class="alert alert-info">
                    <strong>üìã Checkliste:</strong> Dokumentieren Sie den Zustand vor Beginn der Arbeiten.
                </div>

                <div class="form-group">
                    <label>System-Status (PRE)</label>
                    <textarea id="preSystemStatus" rows="4" placeholder="Dokumentieren Sie den aktuellen Systemzustand: Service-Status, Versionen, Cluster Health, etc."></textarea>
                </div>

                <div class="form-group">
                    <label>Backup/Snapshot ID</label>
                    <input type="text" id="backupId" placeholder="snapshot-2024-01-15-pre-maintenance">
                </div>

                <div class="form-group">
                    <label>Risikoeinsch√§tzung</label>
                    <select id="riskLevel">
                        <option value="low">Niedrig - Routine-Wartung</option>
                        <option value="medium">Mittel - Konfigurations√§nderungen</option>
                        <option value="high">Hoch - Major Upgrade oder kritische √Ñnderungen</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Rollback-Plan</label>
                    <textarea id="rollbackPlan" rows="3" placeholder="Beschreiben Sie die Rollback-Strategie falls etwas schief geht..."></textarea>
                </div>
            </div>

            <!-- During Maintenance -->
            <div class="section">
                <h2>‚öôÔ∏è W√§hrend der Wartung</h2>

                <div class="form-group">
                    <label>Durchgef√ºhrte Schritte</label>
                    <textarea id="executedSteps" rows="6" placeholder="Dokumentieren Sie chronologisch alle durchgef√ºhrten Schritte:
1. Service gestoppt um 14:00
2. Paket aktualisiert um 14:05
3. Service gestartet um 14:10
..."></textarea>
                </div>

                <h3>üö® Probleme & L√∂sungen</h3>
                <div id="problemsList">
                    <!-- Problems will be dynamically added here -->
                </div>

                <button class="btn-primary" onclick="addProblem()">+ Problem dokumentieren</button>
            </div>

            <!-- Post-Maintenance -->
            <div class="section">
                <h2>‚úÖ Nach der Wartung</h2>

                <div class="form-group">
                    <label>System-Status (POST)</label>
                    <textarea id="postSystemStatus" rows="4" placeholder="Dokumentieren Sie den Systemzustand nach den Arbeiten: Service-Status, Versionen, Cluster Health, etc."></textarea>
                </div>

                <div class="form-group">
                    <label>Verifikation</label>
                    <textarea id="verification" rows="4" placeholder="Best√§tigen Sie, dass alle Funktionen korrekt arbeiten:
- Alle Services aktiv
- Cluster Health: GREEN
- Dashboards erreichbar
- Agents connected
..."></textarea>
                </div>

                <div class="form-group">
                    <label>Erfolg</label>
                    <select id="success">
                        <option value="full">Vollst√§ndig erfolgreich</option>
                        <option value="partial">Teilweise erfolgreich (mit Einschr√§nkungen)</option>
                        <option value="failed">Fehlgeschlagen (Rollback durchgef√ºhrt)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Lessons Learned</label>
                    <textarea id="lessonsLearned" rows="3" placeholder="Was haben wir gelernt? Was sollte beim n√§chsten Mal besser gemacht werden?"></textarea>
                </div>

                <div class="form-group">
                    <label>Follow-Up Aktionen</label>
                    <textarea id="followUp" rows="3" placeholder="Gibt es offene Punkte oder notwendige Folgeaktionen?"></textarea>
                </div>
            </div>

            <!-- Export -->
            <div class="section">
                <h2>üíæ Export & Archivierung</h2>
                
                <div class="alert alert-success">
                    <strong>‚úÖ Fertig:</strong> Exportieren Sie das Protokoll als PDF zur Archivierung.
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="generatePDF()">üìÑ Als PDF exportieren</button>
                    <button class="btn-primary" onclick="saveToLocalStorage()">üíæ Zwischenspeichern</button>
                    <button class="btn-secondary" onclick="loadFromLocalStorage()">üìÇ Laden</button>
                    <button class="btn-danger" onclick="clearAll()">üóëÔ∏è Alles l√∂schen</button>
                </div>
            </div>
        </div>

        <footer class="ta-footer">
            <p>&copy; 2026 <a href="https://www.t-alpha.ch" target="_blank">T-Alpha GmbH</a> &middot; IT Security &middot; <a href="https://req.t-alpha.ch/" target="_blank">req.t-alpha.ch</a></p>
        </footer>
    </div>

    <script>
        let timerInterval = null;
        let elapsedSeconds = 0;
        let timerRunning = false;
        let problems = [];

        // Timer functions
        function startTimer() {
            if (timerRunning) return;
            
            timerRunning = true;
            const now = new Date().toISOString().slice(0, 16);
            if (!document.getElementById('actualStart').value) {
                document.getElementById('actualStart').value = now;
            }
            
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                updateTimeDisplay();
            }, 1000);
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            
            updateStatus('in-progress');
        }

        function pauseTimer() {
            if (!timerRunning) return;
            
            timerRunning = false;
            clearInterval(timerInterval);
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        function stopTimer() {
            timerRunning = false;
            clearInterval(timerInterval);
            
            const now = new Date().toISOString().slice(0, 16);
            document.getElementById('actualEnd').value = now;
            document.getElementById('totalDuration').value = Math.floor(elapsedSeconds / 60);
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus('completed');
        }

        function resetTimer() {
            if (confirm('Timer wirklich zur√ºcksetzen? Alle Zeitdaten gehen verloren.')) {
                timerRunning = false;
                clearInterval(timerInterval);
                elapsedSeconds = 0;
                updateTimeDisplay();
                
                document.getElementById('actualStart').value = '';
                document.getElementById('actualEnd').value = '';
                document.getElementById('totalDuration').value = '';
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                document.getElementById('stopBtn').disabled = true;
            }
        }

        function updateTimeDisplay() {
            const hours = Math.floor(elapsedSeconds / 3600);
            const minutes = Math.floor((elapsedSeconds % 3600) / 60);
            const seconds = elapsedSeconds % 60;
            
            const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeDisplay').textContent = display;
        }

        function updateStatus(status) {
            document.getElementById('status').value = status;
            updateStatusBadge();
        }

        function updateStatusBadge() {
            const status = document.getElementById('status').value;
            const badge = document.getElementById('statusBadge');
            
            badge.className = 'status-badge';
            
            switch(status) {
                case 'planned':
                    badge.classList.add('status-planned');
                    badge.textContent = 'Geplant';
                    break;
                case 'in-progress':
                    badge.classList.add('status-in-progress');
                    badge.textContent = 'In Bearbeitung';
                    break;
                case 'completed':
                    badge.classList.add('status-completed');
                    badge.textContent = 'Abgeschlossen';
                    break;
            }
        }

        // Problem management
        function addProblem() {
            const problem = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('de-DE'),
                description: '',
                resolution: '',
                resolved: false
            };
            
            problems.push(problem);
            renderProblems();
        }

        function updateProblem(id, field, value) {
            const problem = problems.find(p => p.id === id);
            if (problem) {
                problem[field] = value;
            }
        }

        function toggleResolved(id) {
            const problem = problems.find(p => p.id === id);
            if (problem) {
                problem.resolved = !problem.resolved;
                renderProblems();
            }
        }

        function removeProblem(id) {
            if (confirm('Problem wirklich l√∂schen?')) {
                problems = problems.filter(p => p.id !== id);
                renderProblems();
            }
        }

        function renderProblems() {
            const container = document.getElementById('problemsList');
            
            if (problems.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">Keine Probleme dokumentiert (das ist gut! üéâ)</p>';
                return;
            }
            
            container.innerHTML = problems.map(problem => `
                <div class="problem-entry" style="${problem.resolved ? 'opacity: 0.7; border-color: #28a745;' : ''}">
                    <h4>${problem.resolved ? '‚úÖ' : '‚ö†Ô∏è'} Problem #${problem.id}</h4>
                    <div class="timestamp">Erfasst: ${problem.timestamp}</div>
                    <div class="form-group">
                        <label>Problembeschreibung</label>
                        <textarea rows="2" placeholder="Was ist passiert?" 
                                  onchange="updateProblem(${problem.id}, 'description', this.value)">${problem.description}</textarea>
                    </div>
                    <div class="form-group">
                        <label>L√∂sung</label>
                        <textarea rows="2" placeholder="Wie wurde es gel√∂st?" 
                                  onchange="updateProblem(${problem.id}, 'resolution', this.value)">${problem.resolution}</textarea>
                    </div>
                    <div class="actions">
                        <button class="btn-${problem.resolved ? 'secondary' : 'success'} btn-small" 
                                onclick="toggleResolved(${problem.id})">
                            ${problem.resolved ? '‚Ü©Ô∏è Als offen markieren' : '‚úÖ Als gel√∂st markieren'}
                        </button>
                        <button class="btn-danger btn-small" onclick="removeProblem(${problem.id})">
                            üóëÔ∏è L√∂schen
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Storage functions
        function saveToLocalStorage() {
            const data = {
                operator: document.getElementById('operator').value,
                customer: document.getElementById('customer').value,
                infrastructure: document.getElementById('infrastructure').value,
                changeTicket: document.getElementById('changeTicket').value,
                maintenanceType: document.getElementById('maintenanceType').value,
                description: document.getElementById('description').value,
                plannedStart: document.getElementById('plannedStart').value,
                plannedEnd: document.getElementById('plannedEnd').value,
                status: document.getElementById('status').value,
                actualStart: document.getElementById('actualStart').value,
                actualEnd: document.getElementById('actualEnd').value,
                totalDuration: document.getElementById('totalDuration').value,
                preSystemStatus: document.getElementById('preSystemStatus').value,
                backupId: document.getElementById('backupId').value,
                riskLevel: document.getElementById('riskLevel').value,
                rollbackPlan: document.getElementById('rollbackPlan').value,
                executedSteps: document.getElementById('executedSteps').value,
                postSystemStatus: document.getElementById('postSystemStatus').value,
                verification: document.getElementById('verification').value,
                success: document.getElementById('success').value,
                lessonsLearned: document.getElementById('lessonsLearned').value,
                followUp: document.getElementById('followUp').value,
                problems: problems,
                elapsedSeconds: elapsedSeconds
            };
            
            localStorage.setItem('maintenance_protocol', JSON.stringify(data));
            alert('‚úÖ Daten wurden lokal gespeichert!');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('maintenance_protocol');
            if (!saved) {
                alert('Keine gespeicherten Daten gefunden.');
                return;
            }
            
            const data = JSON.parse(saved);
            
            document.getElementById('operator').value = data.operator || '';
            document.getElementById('customer').value = data.customer || '';
            document.getElementById('infrastructure').value = data.infrastructure || '';
            document.getElementById('changeTicket').value = data.changeTicket || '';
            document.getElementById('maintenanceType').value = data.maintenanceType || 'upgrade';
            document.getElementById('description').value = data.description || '';
            document.getElementById('plannedStart').value = data.plannedStart || '';
            document.getElementById('plannedEnd').value = data.plannedEnd || '';
            document.getElementById('status').value = data.status || 'planned';
            document.getElementById('actualStart').value = data.actualStart || '';
            document.getElementById('actualEnd').value = data.actualEnd || '';
            document.getElementById('totalDuration').value = data.totalDuration || '';
            document.getElementById('preSystemStatus').value = data.preSystemStatus || '';
            document.getElementById('backupId').value = data.backupId || '';
            document.getElementById('riskLevel').value = data.riskLevel || 'low';
            document.getElementById('rollbackPlan').value = data.rollbackPlan || '';
            document.getElementById('executedSteps').value = data.executedSteps || '';
            document.getElementById('postSystemStatus').value = data.postSystemStatus || '';
            document.getElementById('verification').value = data.verification || '';
            document.getElementById('success').value = data.success || 'full';
            document.getElementById('lessonsLearned').value = data.lessonsLearned || '';
            document.getElementById('followUp').value = data.followUp || '';
            
            problems = data.problems || [];
            elapsedSeconds = data.elapsedSeconds || 0;
            
            updateTimeDisplay();
            updateStatusBadge();
            renderProblems();
            
            alert('‚úÖ Daten wurden geladen!');
        }

        function clearAll() {
            if (!confirm('Wirklich alle Daten l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) {
                return;
            }
            
            localStorage.removeItem('maintenance_protocol');
            location.reload();
        }

        // PDF Export
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const leftMargin = 15;
            let yPos = 20;
            const lineHeight = 7;
            const pageHeight = doc.internal.pageSize.height;
            
            function checkNewPage() {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                }
            }
            
            // Title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Wartungsprotokoll', leftMargin, yPos);
            yPos += 15;
            
            // Basic Info
            doc.setFontSize(14);
            doc.text('Grundinformationen', leftMargin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const basicInfo = [
                ['Operator:', document.getElementById('operator').value],
                ['Kunde:', document.getElementById('customer').value],
                ['Infrastruktur:', document.getElementById('infrastructure').value],
                ['Change Ticket:', document.getElementById('changeTicket').value],
                ['Wartungstyp:', document.getElementById('maintenanceType').value],
                ['Status:', document.getElementById('status').value],
                ['Erstellt am:', new Date().toLocaleString('de-DE')]
            ];
            
            basicInfo.forEach(([label, value]) => {
                checkNewPage();
                doc.text(`${label} ${value || 'N/A'}`, leftMargin, yPos);
                yPos += lineHeight;
            });
            
            yPos += 5;
            
            // Description
            const description = document.getElementById('description').value;
            if (description) {
                checkNewPage();
                doc.setFont(undefined, 'bold');
                doc.text('Beschreibung:', leftMargin, yPos);
                yPos += lineHeight;
                doc.setFont(undefined, 'normal');
                const descLines = doc.splitTextToSize(description, 180);
                descLines.forEach(line => {
                    checkNewPage();
                    doc.text(line, leftMargin, yPos);
                    yPos += lineHeight;
                });
            }
            
            yPos += 10;
            
            // Timing
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            checkNewPage();
            doc.text('Zeiterfassung', leftMargin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            const timing = [
                ['Geplant Start:', document.getElementById('plannedStart').value],
                ['Geplant Ende:', document.getElementById('plannedEnd').value],
                ['Tats√§chlich Start:', document.getElementById('actualStart').value],
                ['Tats√§chlich Ende:', document.getElementById('actualEnd').value],
                ['Dauer (Minuten):', document.getElementById('totalDuration').value]
            ];
            
            timing.forEach(([label, value]) => {
                checkNewPage();
                doc.text(`${label} ${value || 'N/A'}`, leftMargin, yPos);
                yPos += lineHeight;
            });
            
            // Add new page for problems and details
            doc.addPage();
            yPos = 20;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Probleme & L√∂sungen', leftMargin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            if (problems.length === 0) {
                doc.text('Keine Probleme aufgetreten', leftMargin, yPos);
                yPos += lineHeight;
            } else {
                problems.forEach((problem, index) => {
                    checkNewPage();
                    doc.setFont(undefined, 'bold');
                    doc.text(`Problem ${index + 1} ${problem.resolved ? '[GEL√ñST]' : '[OFFEN]'}`, leftMargin, yPos);
                    yPos += lineHeight;
                    doc.setFont(undefined, 'normal');
                    doc.text(`Zeitpunkt: ${problem.timestamp}`, leftMargin + 5, yPos);
                    yPos += lineHeight;
                    
                    if (problem.description) {
                        const descLines = doc.splitTextToSize(`Beschreibung: ${problem.description}`, 170);
                        descLines.forEach(line => {
                            checkNewPage();
                            doc.text(line, leftMargin + 5, yPos);
                            yPos += lineHeight;
                        });
                    }
                    
                    if (problem.resolution) {
                        const resLines = doc.splitTextToSize(`L√∂sung: ${problem.resolution}`, 170);
                        resLines.forEach(line => {
                            checkNewPage();
                            doc.text(line, leftMargin + 5, yPos);
                            yPos += lineHeight;
                        });
                    }
                    
                    yPos += 3;
                });
            }
            
            // Completion
            yPos += 10;
            checkNewPage();
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Abschluss', leftMargin, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Erfolg: ${document.getElementById('success').value}`, leftMargin, yPos);
            yPos += lineHeight * 2;
            
            const verification = document.getElementById('verification').value;
            if (verification) {
                checkNewPage();
                doc.text('Verifikation:', leftMargin, yPos);
                yPos += lineHeight;
                const verLines = doc.splitTextToSize(verification, 180);
                verLines.forEach(line => {
                    checkNewPage();
                    doc.text(line, leftMargin, yPos);
                    yPos += lineHeight;
                });
            }
            
            // Add page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Seite ${i} von ${pageCount}`, 
                    doc.internal.pageSize.width / 2, 
                    doc.internal.pageSize.height - 10, 
                    { align: 'center' });
            }
            
            const filename = `Wartungsprotokoll_${document.getElementById('customer').value.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            
            alert('‚úÖ PDF wurde erfolgreich erstellt!');
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            updateStatusBadge();
            renderProblems();
        });
    </script>
</body>
</html>
